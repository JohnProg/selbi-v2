machine:
  node:
    version: 4.4.4

dependencies:
  override:
    - alias gcloud='sudo /opt/google-cloud-sdk/bin/gcloud'
    - npm install -g mocha
    - npm install -g firebase-tools
    - cd selbi-backend && npm install
    - cd selbi-stripe-worker && npm install
    - cd service-accounts && npm install
    - cd firebase-test-resource && npm install
    - cd Selbi && npm install

test:
  override:
    - cd selbi-backend && npm test
    - cd selbi-stripe-worker && npm test
    - cd service-accounts && npm test
    - cd firebase-test-resource && npm test
    - cd Selbi && npm test

# TODO: Consider how we deploy private node modules here. Manual publish from a machine is fine for now
#  but at somepoint we'll want to do it in a CI environment. Perhaps this is a reason to move to seperate repos.

deployment:
  staging:
    branch: staging
    commands:
      - cd selbi-backend && ./deploy staging
      - cd selbi-stripe-worker && ./deploy staging
      - cd selbi-web && ./deploy staging
      - cd Selbi && ./deploy staging js
  production:
    branch: production
    commands:
      - cd selbi-backend && ./deploy production
      - cd selbi-stripe-worker && ./deploy production
      - cd selbi-web && ./deploy production
      - cd Selbi && ./deploy production js
